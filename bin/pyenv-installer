#!/usr/bin/env bash
# vim: set et sw=2 sts=2 ts=2 :
#
# Install pyenv w/ virtualenvwrapper
#
# Environment variables this script uses:
#
# XDG_DATA_HOME (set by system)
#   You'll see this mentioned as recommended in place of $HOME. May not always
#   be set though. Typically on linux its "${HOME}/.local/share"
#
# PYENV_DEBUG=
#   if it has any value then turns on debugging
#
# PYENV_ROOT="${HOME}/.pyenv"
#   where pyenv is installed too. alternative suggestion is
#   "${XDG_DATA_HOME}/pyenv"
#
# PYENV_SKIP_UPDATE=
#   if on ubuntu this will install the dependencies needed. Set this to any
#   value, like 'yes', to skip installing these.
#
# PYENV_INITIAL_VERSION=none (not implemented yet)
#   initial version of python to install. This is required for the
#   virtualenvwrapper part of config and this version can not be removed or it
#   may break virtualenvwrapper. Accepts 'none', any version that pyenv knows
#   of, or 'system' which will detect the current version of python the system
#   has and install that with pyenv.
#
# WORKON_HOME="${HOME}/.virtualenvs"
#   Where virtualenvs live. Again suggest "${XDG_DATA_HOME}/virtualenvs" to
#   keep home directory clean.

set -e
[ -n "$PYENV_DEBUG" ] && set -x

if [ -z "$PYENV_ROOT" ]; then
  PYENV_ROOT="${HOME}/.pyenv"
fi

if [ -z "$PYENV_INITIAL_VERSION" ]; then
  PYENV_INITIAL_VERSION='none'
elif [ "$PYENV_INITIAL_VERSION" == "system" ]; then
  system_python="$(python -V 2>&1)"
  PYENV_INITIAL_VERSION="${system_python##* }"
fi

if [ -z "$PYENV_SKIP_UPDATE" ]; then
  if [ -f '/etc/os-release' ] && \
      [ $(grep -c "ubuntu" /etc/os-release) -gt 0 ]; then
    echo "Enter your password to install any dependencies" >&2
    sudo apt-get update
    sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \
      libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm git
  fi
fi

shell="$1"
if [ -z "$shell" ]; then
  shell="$(ps c -p "$PPID" -o 'ucomm=' 2>/dev/null || true)"
  shell="${shell##-}"
  shell="${shell%% *}"
  shell="$(basename "${shell:-$SHELL}")"
fi

colorize() {
  if [ -t 1 ]; then printf "\e[%sm%s\e[m" "$1" "$2"
  else echo -n "$2"
  fi
}

checkout() {
  [ -d "$2" ] || git clone "$1" "$2"
}

if ! command -v git 1>/dev/null 2>&1; then
  echo "pyenv: Git is not installed, can't continue." >&2
  exit 1
fi

checkout "https://github.com/yyuu/pyenv.git"            "${PYENV_ROOT}"
checkout "https://github.com/yyuu/pyenv-doctor.git"     "${PYENV_ROOT}/plugins/pyenv-doctor"
#checkout "https://github.com/yyuu/pyenv-installer.git"  "${PYENV_ROOT}/plugins/pyenv-installer"
checkout "https://github.com/yyuu/pyenv-pip-rehash.git" "${PYENV_ROOT}/plugins/pyenv-pip-rehash"
checkout "https://github.com/yyuu/pyenv-update.git"     "${PYENV_ROOT}/plugins/pyenv-update"
checkout "https://github.com/yyuu/pyenv-virtualenvwrapper.git" "${PYENV_ROOT}/plugins/pyenv-virtualenvwrapper"
checkout "https://github.com/yyuu/pyenv-which-ext.git"  "${PYENV_ROOT}/plugins/pyenv-which-ext"

if ! command -v pyenv 1>/dev/null; then
  { echo
    colorize 1 "WARNING"
    echo ": seems you still have not added 'pyenv' to the load path."
    echo
  } >&2

  case "$shell" in
  bash )
    profile="~/.bash_profile"
    ;;
  zsh )
    profile="~/.zshrc"
    ;;
  ksh )
    profile="~/.profile"
    ;;
  fish )
    profile="~/.config/fish/config.fish"
    ;;
  * )
    profile="your profile"
    ;;
  esac

  loadpath="$(echo "${PYENV_ROOT}" | sed -e "s,$HOME,\$HOME,")"

  { echo "# Load pyenv automatically by adding"
    echo "# the following to ${profile}:"
    echo
    case "$shell" in
    fish )
      echo "set -x PATH \"${loadpath}/bin\" \$PATH"
      echo 'status --is-interactive; and . (pyenv init -|psub)'
      ;;
    * )
      echo "export PATH=\"${loadpath}/bin:\$PATH\""
      echo "export WORKON_HOME=\"\$HOME/.local/share/virtualenvs\""
      echo "export PROJECT_HOME=\"\$HOME/code\""
      echo "eval \"\$(pyenv init -)\""
      ;;
    esac
    echo
    echo "# There's some post install steps for virtualenvwrapper. Do above"
    echo "# commands or source ${profile} then run the following"
    echo
    echo "pyenv install 2.7.8"
    echo "pyenv global 2.7.8"
    echo "pyenv virtualenvwrapper"
    echo
    echo "# Add the following to ${profile} to load automatically"
    echo
    echo "pyenv virtualenvwrapper"
    echo
  } >&2
fi
